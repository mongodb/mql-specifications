# $schema: ../../schema.json
name: $setIntersection
link: https://www.mongodb.com/docs/manual/reference/operator/aggregation/setIntersection/
minVersion: '3.0'
type:
  - resolvesToArray
encode: single
description: |
  Returns a set with elements that appear in all of the input sets. Accepts any number of argument expressions.
arguments:
  - name: expression
    type:
      - resolvesToArray
    variadic: array
tests:
  - name: Elements Array Example
    link: https://www.mongodb.com/docs/manual/reference/operator/aggregation/setIntersection/#elements-array-example
    pipeline:
      - $project:
          flowerFieldA: 1
          flowerFieldB: 1
          commonToBoth:
            $setIntersection:
              - $flowerFieldA
              - $flowerFieldB
          _id: 0
    schema:
      flowers:
        _id:
          types:
            - bsonType: Number
        flowerFieldA:
          types:
            - bsonType: Array
              types:
                - bsonType: String
        flowerFieldB:
          types:
            - bsonType: Array
              types:
                - bsonType: String
                - bsonType: Array
                  types:
                    - bsonType: String
  - name: Retrieve Documents for Roles Granted to the Current User
    link: https://www.mongodb.com/docs/manual/reference/operator/aggregation/setIntersection/#retrieve-documents-for-roles-granted-to-the-current-user
    pipeline:
      - $match:
          $expr:
            $not:
              # the example doesn't use an array inside $not, but the documentation say it is necessary
              - $eq:
                  - $setIntersection:
                      - $allowedRoles
                      - $$USER_ROLES.role
                  - []
    schema:
      budget:
        _id:
          types:
            - bsonType: Int32
        allowedRoles:
          types:
            - bsonType: Array
              types:
                - bsonType: String
        comment:
          types:
            - bsonType: String
        yearlyBudget:
          types:
            - bsonType: Double
        cloudBudget:
          types:
            - bsonType: Double
            - bsonType: Undefined
        salesEventsBudget:
          types:
            - bsonType: Double
            - bsonType: Undefined
